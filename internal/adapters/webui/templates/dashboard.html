{{define "dashboard-content"}}
<div x-data="dashboard()" x-init="init()">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900">–î–∞—à–±–æ—Ä–¥ —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <p class="text-gray-600 mt-2">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫ -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-chart-bar text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">–í—Å–µ–≥–æ —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.total">0</p>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.active">0</p>
                </div>
            </div>
        </div>

        <!-- –ó–∞–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">–ó–∞–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.completed">0</p>
                </div>
            </div>
        </div>

        <!-- –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-dollar-sign text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</p>
                    <p class="text-2xl font-semibold" 
                       :class="stats.totalProfit >= 0 ? 'text-green-600' : 'text-red-600'"
                       x-text="formatCurrency(stats.totalProfit)">
                        $0.00
                    </p>
                </div>
            </div>
        </div>


    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

        <!-- –ë–∞–ª–∞–Ω—Å Bybit -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-wallet mr-2 text-blue-600"></i>–ë–∞–ª–∞–Ω—Å Bybit
            </h3>
            <div class="space-y-3">
                <!-- USDT –±–∞–ª–∞–Ω—Å -->
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-blue-800">USDT</span>
                        <span class="text-lg font-bold text-blue-900" x-text="formatCurrency(balance.usdt?.Available || 0)">$0.00</span>
                    </div>
                    <div class="text-xs text-blue-600 mt-1">
                        –í—Å–µ–≥–æ: <span x-text="formatCurrency(balance.usdt?.Total || 0)">$0.00</span>
                    </div>
                </div>
                
                <!-- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã -->
                <div class="grid grid-cols-2 gap-2" x-show="balance.crypto && Object.keys(balance.crypto).length > 0">
                    <template x-for="(crypto, symbol) in balance.crypto" :key="symbol">
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-gray-700" x-text="symbol"></span>
                                <span class="text-sm font-bold text-gray-900" x-text="formatNumber(crypto.available || 0)">0</span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                <button @click="refreshBalance()" 
                        :disabled="balanceLoading"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    <span x-show="!balanceLoading">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</span>
                    <span x-show="balanceLoading">–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <button @click="executeStrategy()" 
                        :disabled="loading"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors">
                    <i class="fas fa-rocket mr-2"></i>
                    <span x-show="!loading">–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                    <span x-show="loading">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
                <button @click="checkStatuses()" 
                        :disabled="loading"
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    <span x-show="!loading">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –æ—Ä–¥–µ—Ä–æ–≤</span>
                    <span x-show="loading">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
                </button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-heartbeat mr-2 text-green-600"></i>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
            </h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                        <i class="fas fa-circle mr-1"></i>–ü–æ–¥–∫–ª—é—á–µ–Ω–∞
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞</span>
                    <span class="text-sm text-gray-500" x-text="formatTime(lastCheck)">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                        <i class="fas fa-circle mr-1"></i>–ê–∫—Ç–∏–≤–Ω–∞
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-history mr-2 text-gray-600"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –í—Ä–µ–º—è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –ü–∞—Ä–∞
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –°—Ç–∞—Ç—É—Å
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –ü—Ä–∏–±—ã–ª—å
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –†–∞–∑–º–µ—Ä –æ—Ä–¥–µ—Ä–∞
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –ü—Ä–æ—Ñ–∏—Ç %
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="trade in recentTrades" :key="trade.bybit_order_id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                x-text="formatTime(trade.hedge_time)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" 
                                x-text="trade.pair"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                      :class="getStatusClass(trade.order_status)"
                                      x-text="getStatusText(trade.order_status)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm"
                                :class="trade.profit >= 0 ? 'text-green-600' : 'text-red-600'"
                                x-text="formatCurrency(trade.profit)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                x-text="formatCurrency(trade.order_size_usd)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm"
                                :class="getProfitPercent(trade) >= 0 ? 'text-green-600' : 'text-red-600'"
                                x-text="getProfitPercentText(trade)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div x-show="notification" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-2"
         class="fixed top-4 right-4 p-4 rounded-md shadow-lg z-50"
         :class="notificationType === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
        <p x-text="notification"></p>
    </div>
</div>

<script>
function dashboard() {
    return {
        stats: {
            total: 0,
            active: 0,
            completed: 0,
            totalProfit: 0
        },
        recentTrades: [],
        loading: false,
        notification: '',
        notificationType: 'success',
        lastCheck: null,
        balance: {},
        balanceLoading: false,

        init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞...');
            this.loadData();
            this.loadBalance();
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => this.loadData(), 30000);
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            setInterval(() => this.loadBalance(), 120000);
        },

        async loadData() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–∞—Ö...');
                const response = await fetch('/api/trades');
                const data = await response.json();
                
                console.log('üìä –î–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–∞—Ö –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);
                
                this.recentTrades = data.trades || [];
                this.stats = data.stats || this.stats;
                this.lastCheck = new Date();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        },

        async executeStrategy() {
            this.loading = true;
            try {
                const response = await fetch('/api/execute', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showNotification('–•–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    this.loadData();
                } else {
                    this.showNotification(result.message || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                this.showNotification('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
            this.loading = false;
        },

        async checkStatuses() {
            this.loading = true;
            try {
                const response = await fetch('/api/check-status', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showNotification(`–°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${result.updated} –æ—Ä–¥–µ—Ä–æ–≤`, 'success');
                    this.loadData();
                } else {
                    this.showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error');
                }
            } catch (error) {
                this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message, 'error');
            }
            this.loading = false;
        },

        showNotification(message, type = 'success') {
            this.notification = message;
            this.notificationType = type;
            setTimeout(() => {
                this.notification = '';
            }, 5000);
        },

        formatCurrency(amount) {
            if (amount === null || amount === undefined) return '‚Äî';
            return '$' + amount.toFixed(6);
        },

        formatTime(dateStr) {
            if (!dateStr) return '‚Äî';
            return new Date(dateStr).toLocaleString('ru-RU');
        },

        getStatusClass(status) {
            switch (status) {
                case 'FILLED':
                    return 'bg-green-100 text-green-800';
                case 'PENDING':
                    return 'bg-yellow-100 text-yellow-800';
                case 'CANCELLED':
                case 'REJECTED':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },

        getStatusText(status) {
            const statusTexts = {
                'FILLED': '–ò—Å–ø–æ–ª–Ω–µ–Ω',
                'PENDING': '–û–∂–∏–¥–∞–µ—Ç',
                'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω',
                'REJECTED': '–û—Ç–∫–ª–æ–Ω–µ–Ω',
                'UNKNOWN': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
            };
            return statusTexts[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        },

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏—Ç –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –¥–ª—è —Å–¥–µ–ª–∫–∏
        getProfitPercent(trade) {
            // –¢–æ–ª—å–∫–æ –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–¥–µ–ª–æ–∫)
            if (trade.order_status === 'FILLED' && trade.close_price) {
                return ((trade.close_price - trade.hedge_open_price) / trade.hedge_open_price) * 100;
            }
            return 0;
        },

        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏—Ç–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        getProfitPercentText(trade) {
            const profitPercent = this.getProfitPercent(trade);
            if (profitPercent === 0) {
                return '‚Äî';
            }
            
            const sign = profitPercent >= 0 ? '+' : '';
            return sign + profitPercent.toFixed(2) + '%';
        },

        // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å Bybit
        async loadBalance() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å...');
                const response = await fetch('/api/balance');
                const result = await response.json();
                
                console.log('üìä –û—Ç–≤–µ—Ç API –±–∞–ª–∞–Ω—Å–∞:', result);
                
                if (result.success) {
                    this.balance = result.data;
                    console.log('‚úÖ –ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–µ–Ω:', this.balance);
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', result.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
            }
        },

        // –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
        async refreshBalance() {
            this.balanceLoading = true;
            try {
                await this.loadBalance();
                this.showNotification('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            } catch (error) {
                this.showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ' + error.message, 'error');
            }
            this.balanceLoading = false;
        },

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–∞ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        formatNumber(amount) {
            if (amount === null || amount === undefined) return '‚Äî';
            if (amount < 0.000001) return amount.toExponential(2);
            if (amount < 0.001) return amount.toFixed(8);
            if (amount < 1) return amount.toFixed(6);
            if (amount < 1000) return amount.toFixed(4);
            return amount.toFixed(2);
        }
    }
}
</script>
{{end}}
