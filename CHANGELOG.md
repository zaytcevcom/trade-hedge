# Журнал изменений Trade Hedge

## [Неопубликованная версия] - 2024-12-19

### Изменено
- **Убрана автоматическая корректировка размера позиции** - Теперь система НЕ будет автоматически уменьшать размер позиции до доступного баланса
- **Строгая проверка баланса** - Если баланса недостаточно для указанной в настройках суммы позиции, пара пропускается без попытки размещения ордера на оставшийся баланс
- **Добавлена сортировка сделок по просадке** - Сделки теперь сортируются по максимальной просадке (от большей к меньшей) для приоритизации самых убыточных позиций

### Детали изменений
- В файле `internal/usecases/hedge_strategy.go` убрана логика автоматической корректировки `adjustedPositionAmount`
- Теперь используется строго фиксированный размер позиции из настроек `h.config.PositionAmount`
- При недостатке баланса система возвращает ошибку `InsufficientBalanceError` и пропускает пару
- Улучшены логи для более четкого понимания причин пропуска пары
- В файле `internal/domain/entities/trade.go` добавлена функция `SortTradesByDrawdown()` для сортировки сделок по просадке
- В стратегии хеджирования добавлена сортировка сделок перед их обработкой
- Улучшено логирование с отображением просадки каждой сделки и порядка их обработки
- Добавлено детальное логирование всех сделок (без ограничения в 5 штук)
- Показывается информация о пропущенных сделках с недостаточной просадкой
- Добавлено отображение размера ордера в долларах на страницах dashboard и trades
- Убран блок "Средний размер позиции" с дашборда для упрощения интерфейса
- Убраны избыточные логи Bybit Balance API и Instrument Info API для уменьшения шума в логах
- **Умная фильтрация хеджирования** - Сделки с активными ордерами в ожидании (PENDING) блокируются, завершенные ордера (FILLED/CANCELLED/REJECTED) разрешают повторное хеджирование
- **Разрешено повторное хеджирование завершенных ордеров** - Если хедж-ордер исполнился (FILLED) или отменен (CANCELLED), можно создать новый при повторном убытке
- **Блокировка дублирования активных ордеров** - Нельзя создать новый хедж-ордер, пока предыдущий находится в ожидании
- **Добавлена функция GetHedgeHistory** - Для получения истории всех хедж-ордеров по конкретной сделке

### Детали изменений хеджирования
- В файле `internal/usecases/hedge_strategy.go` восстановлена и улучшена функция `filterUnhedgedTrades()`:
  - Проверяется наличие активных ордеров в статусе PENDING
  - Сделки с активными ордерами блокируются (ждем исполнения)
  - Сделки с завершенными ордерами могут хеджироваться повторно
  - Добавлено детальное логирование причин блокировки/разрешения
- Добавлена функция `GetHedgeHistory()` для получения истории всех хедж-ордеров по сделке
- Обновлены интерфейсы и адаптеры репозитория для поддержки новой функциональности

### Преимущества
- **Предсказуемость** - Размер позиции всегда соответствует настройкам
- **Безопасность** - Нет риска размещения слишком маленьких ордеров
- **Контроль** - Пользователь точно знает, на какую сумму будут размещаться ордера
- **Приоритизация рисков** - Сначала хеджируются самые убыточные позиции, что минимизирует общие потери
- **Прозрачность** - Четкое отображение просадки каждой сделки и порядка их обработки
- **Полная видимость** - Логируются все сделки без ограничений, включая пропущенные
- **Финансовая прозрачность** - Отображается размер каждого ордера в долларах
- **Практичная статистика** - Показывается средний размер позиции вместо общей суммы
- **Чистые логи** - Убраны избыточные API логи для лучшей читаемости
- **Умная защита от дублирования** - Нельзя создать новый хедж-ордер, пока предыдущий активен
- **Гибкость повторного хеджирования** - Завершенные ордера не блокируют новые попытки хеджирования
- **Адаптивность к рынку** - Система может создавать дополнительные хедж-позиции при углублении убытков
- **Полная прозрачность** - Детальная история всех хедж-ордеров с отображением статусов и причин блокировки

### Настройки
- `STRATEGY_POSITION_AMOUNT` - Фиксированная сумма позиции в USDT (минимум 100 USDT для соответствия лимитам Bybit)
- Убедитесь, что на балансе достаточно средств для указанной суммы позиции
